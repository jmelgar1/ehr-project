#!/bin/sh
# Maven Wrapper script
# https://maven.apache.org/wrapper/
set -e

if [ -z "$JAVA_HOME" ]; then
  JAVACMD="java"
else
  JAVACMD="$JAVA_HOME/bin/java"
fi

MAVEN_PROJECTBASEDIR="${MAVEN_BASEDIR:-$(cd "$(dirname "$0")" && pwd)}"
MAVEN_WRAPPER_PROPERTIES="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.properties"
MAVEN_WRAPPER_JAR="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.jar"

if [ -f "$MAVEN_WRAPPER_PROPERTIES" ]; then
  DISTRIBUTION_URL=$(grep -o 'distributionUrl=.*' "$MAVEN_WRAPPER_PROPERTIES" | cut -d'=' -f2-)
  WRAPPER_URL=$(grep -o 'wrapperUrl=.*' "$MAVEN_WRAPPER_PROPERTIES" | cut -d'=' -f2-)
fi

DISTRIBUTION_URL="${DISTRIBUTION_URL:-https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.9/apache-maven-3.9.9-bin.zip}"

MAVEN_HOME="$HOME/.m2/wrapper/dists/$(basename "$DISTRIBUTION_URL" .zip)"

if [ ! -d "$MAVEN_HOME" ]; then
  echo "Downloading Maven from $DISTRIBUTION_URL"
  mkdir -p "$MAVEN_HOME"
  if command -v curl > /dev/null 2>&1; then
    curl -fsSL "$DISTRIBUTION_URL" -o "$MAVEN_HOME/maven.zip"
  elif command -v wget > /dev/null 2>&1; then
    wget -q "$DISTRIBUTION_URL" -O "$MAVEN_HOME/maven.zip"
  else
    echo "Error: Neither curl nor wget found." >&2
    exit 1
  fi
  unzip -q "$MAVEN_HOME/maven.zip" -d "$MAVEN_HOME"
  rm -f "$MAVEN_HOME/maven.zip"
fi

MAVEN_BIN=$(find "$MAVEN_HOME" -name "mvn" -path "*/bin/mvn" | head -1)

if [ -z "$MAVEN_BIN" ]; then
  echo "Error: Could not find Maven executable in $MAVEN_HOME" >&2
  exit 1
fi

exec "$MAVEN_BIN" \
  -Dmaven.multiModuleProjectDirectory="$MAVEN_PROJECTBASEDIR" \
  "$@"
