services:
  # ===================
  # DATABASES
  # ===================
  postgres-auth:
    image: postgres:18.1-alpine
    container_name: ehr-postgres-auth
    environment:
      POSTGRES_DB: ${AUTH_DB_NAME:-ehr_auth_db}
      POSTGRES_USER: ${AUTH_DB_USER:-ehr_user}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-ehr_password}
    ports:
      - "5436:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_DB_USER:-ehr_user} -d ${AUTH_DB_NAME:-ehr_auth_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-patient:
    image: postgres:18.1-alpine
    container_name: ehr-postgres-patient
    environment:
      POSTGRES_DB: ${PATIENT_DB_NAME:-ehr_patient_db}
      POSTGRES_USER: ${PATIENT_DB_USER:-ehr_user}
      POSTGRES_PASSWORD: ${PATIENT_DB_PASSWORD:-ehr_password}
    ports:
      - "5433:5432"
    volumes:
      - postgres-patient-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PATIENT_DB_USER:-ehr_user} -d ${PATIENT_DB_NAME:-ehr_patient_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-session:
    image: postgres:18.1-alpine
    container_name: ehr-postgres-session
    environment:
      POSTGRES_DB: ${SESSION_DB_NAME:-ehr_session_db}
      POSTGRES_USER: ${SESSION_DB_USER:-ehr_user}
      POSTGRES_PASSWORD: ${SESSION_DB_PASSWORD:-ehr_password}
    ports:
      - "5434:5432"
    volumes:
      - postgres-session-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SESSION_DB_USER:-ehr_user} -d ${SESSION_DB_NAME:-ehr_session_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-notification:
    image: postgres:18.1-alpine
    container_name: ehr-postgres-notification
    environment:
      POSTGRES_DB: ${NOTIFICATION_DB_NAME:-ehr_notification_db}
      POSTGRES_USER: ${NOTIFICATION_DB_USER:-ehr_user}
      POSTGRES_PASSWORD: ${NOTIFICATION_DB_PASSWORD:-ehr_password}
    ports:
      - "5435:5432"
    volumes:
      - postgres-notification-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${NOTIFICATION_DB_USER:-ehr_user} -d ${NOTIFICATION_DB_NAME:-ehr_notification_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-assessment:
    image: postgres:18.1-alpine
    container_name: ehr-postgres-assessment
    environment:
      POSTGRES_DB: ${ASSESSMENT_DB_NAME:-ehr_assessment_db}
      POSTGRES_USER: ${ASSESSMENT_DB_USER:-ehr_user}
      POSTGRES_PASSWORD: ${ASSESSMENT_DB_PASSWORD:-ehr_password}
    ports:
      - "5438:5432"
    volumes:
      - postgres-assessment-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${ASSESSMENT_DB_USER:-ehr_user} -d ${ASSESSMENT_DB_NAME:-ehr_assessment_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4
    container_name: ehr-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres-auth
      - postgres-patient
      - postgres-session
      - postgres-notification
      - postgres-assessment

  # ===================
  # SERVICES
  # ===================
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: ehr-api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - AUTH_SERVICE_URL=http://auth-service:8084
      - PATIENT_SERVICE_URL=http://patient-service:8081
      - SESSION_SERVICE_URL=http://session-service:8082
      - NOTIFICATION_SERVICE_URL=http://notification-service:8083
      - ASSESSMENT_SERVICE_URL=http://assessment-service:8086
      - JWT_SECRET=${JWT_SECRET}

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: ehr-auth-service
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-auth:5432/${AUTH_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${AUTH_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${AUTH_DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION}
    depends_on:
      postgres-auth:
        condition: service_healthy

  patient-service:
    build:
      context: ./patient-service
      dockerfile: Dockerfile
    container_name: ehr-patient-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-patient:5432/${PATIENT_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${PATIENT_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${PATIENT_DB_PASSWORD}
    depends_on:
      postgres-patient:
        condition: service_healthy

  session-service:
    build:
      context: ./session-service
      dockerfile: Dockerfile
    container_name: ehr-session-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-session:5432/${SESSION_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${SESSION_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${SESSION_DB_PASSWORD}
      - PATIENT_SERVICE_URL=http://patient-service:8081
    depends_on:
      postgres-session:
        condition: service_healthy
      patient-service:
        condition: service_started

  notification-service:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: ehr-notification-service
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-notification:5432/${NOTIFICATION_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${NOTIFICATION_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${NOTIFICATION_DB_PASSWORD}
      - PATIENT_SERVICE_URL=http://patient-service:8081
      - SESSION_SERVICE_URL=http://session-service:8082
    depends_on:
      postgres-notification:
        condition: service_healthy
      patient-service:
        condition: service_started
      session-service:
        condition: service_started

  assessment-service:
    build:
      context: ./assessment-service
      dockerfile: Dockerfile
    container_name: ehr-assessment-service
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-assessment:5432/${ASSESSMENT_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${ASSESSMENT_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${ASSESSMENT_DB_PASSWORD}
      - PATIENT_SERVICE_URL=http://patient-service:8081
    depends_on:
      postgres-assessment:
        condition: service_healthy
      patient-service:
        condition: service_started

  ehr-app:
    build:
      context: ./ehr-app
      dockerfile: Dockerfile
    container_name: ehr-app
    ports:
      - "3000:80"
    depends_on:
      - api-gateway

volumes:
  postgres-auth-data:
  postgres-patient-data:
  postgres-session-data:
  postgres-notification-data:
  postgres-assessment-data:
  pgadmin-data:
