name: Test

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      auth-service: ${{ steps.filter.outputs.auth-service }}
      patient-service: ${{ steps.filter.outputs.patient-service }}
      api-gateway: ${{ steps.filter.outputs.api-gateway }}
      assessment-service: ${{ steps.filter.outputs.assessment-service }}
      notification-service: ${{ steps.filter.outputs.notification-service }}
      session-service: ${{ steps.filter.outputs.session-service }}
      ehr-app: ${{ steps.filter.outputs.ehr-app }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth-service:
              - 'auth-service/**'
            patient-service:
              - 'patient-service/**'
            api-gateway:
              - 'api-gateway/**'
            assessment-service:
              - 'assessment-service/**'
            notification-service:
              - 'notification-service/**'
            session-service:
              - 'session-service/**'
            ehr-app:
              - 'ehr-app/**'

  # ============================================
  # Backend Services (Java/Maven)
  # ============================================

  test-auth-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth-service == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: auth-service
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: ./mvnw test --batch-mode

  test-patient-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.patient-service == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: patient-service
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: ./mvnw test --batch-mode

  test-api-gateway:
    needs: detect-changes
    if: needs.detect-changes.outputs.api-gateway == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api-gateway
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: ./mvnw test --batch-mode

  test-assessment-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.assessment-service == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: assessment-service
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: ./mvnw test --batch-mode

  test-notification-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.notification-service == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: notification-service
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: ./mvnw test --batch-mode

  test-session-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.session-service == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: session-service
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: ./mvnw test --batch-mode

  # ============================================
  # Frontend (ehr-app)
  # ============================================

  test-ehr-app:
    needs: detect-changes
    if: needs.detect-changes.outputs.ehr-app == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ehr-app
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ehr-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  # ============================================
  # Status Check (for branch protection)
  # ============================================

  tests-passed:
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - test-auth-service
      - test-patient-service
      - test-api-gateway
      - test-assessment-service
      - test-notification-service
      - test-session-service
      - test-ehr-app
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Auth Service: ${{ needs.test-auth-service.result }}"
          echo "Patient Service: ${{ needs.test-patient-service.result }}"
          echo "API Gateway: ${{ needs.test-api-gateway.result }}"
          echo "Assessment Service: ${{ needs.test-assessment-service.result }}"
          echo "Notification Service: ${{ needs.test-notification-service.result }}"
          echo "Session Service: ${{ needs.test-session-service.result }}"
          echo "EHR App: ${{ needs.test-ehr-app.result }}"

          # Fail if any job failed (not skipped)
          if [[ "${{ needs.test-auth-service.result }}" == "failure" ]] || \
             [[ "${{ needs.test-patient-service.result }}" == "failure" ]] || \
             [[ "${{ needs.test-api-gateway.result }}" == "failure" ]] || \
             [[ "${{ needs.test-assessment-service.result }}" == "failure" ]] || \
             [[ "${{ needs.test-notification-service.result }}" == "failure" ]] || \
             [[ "${{ needs.test-session-service.result }}" == "failure" ]] || \
             [[ "${{ needs.test-ehr-app.result }}" == "failure" ]]; then
            echo "One or more test jobs failed"
            exit 1
          fi

          echo "All relevant tests passed!"
